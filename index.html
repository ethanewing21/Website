<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Money Tracker Pro - Local First</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(135deg, #2c3e50, #34495e);
      color: white;
      padding: 30px;
      text-align: center;
      position: relative;
    }

    .header h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
    }

    .sync-status {
      position: absolute;
      top: 20px;
      right: 20px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      backdrop-filter: blur(10px);
    }

    .sync-status.connected {
      background: rgba(46, 204, 113, 0.3);
      color: #2ecc71;
    }

    .sync-status.syncing {
      background: rgba(241, 196, 15, 0.3);
      color: #f1c40f;
    }

    .sync-status.offline {
      background: rgba(231, 76, 60, 0.3);
      color: #e74c3c;
    }

    .sync-status.local-first {
      background: rgba(52, 152, 219, 0.3);
      color: #3498db;
    }

    .period-selector {
      margin: 20px 0;
      display: flex;
      gap: 15px;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .period-btn {
      padding: 10px 20px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1);
      color: white;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s;
      backdrop-filter: blur(10px);
    }

    .period-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .period-btn.active {
      background: rgba(255, 255, 255, 0.3);
      border-color: rgba(255, 255, 255, 0.6);
    }

    .grand-total {
      font-size: 3em;
      font-weight: bold;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 15px;
      backdrop-filter: blur(10px);
    }

    .grand-total.positive {
      color: #2ecc71;
    }

    .grand-total.negative {
      color: #e74c3c;
    }

    .main-content {
      display: grid;
      grid-template-columns: 1fr 400px;
      gap: 30px;
      padding: 30px;
    }

    .input-section {
      background: #f8f9fa;
      padding: 30px;
      border-radius: 15px;
      border: 2px solid #e9ecef;
    }

    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c3e50;
    }

    input,
    select {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
      transition: border-color 0.3s;
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .type-selector {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }

    .type-btn {
      flex: 1;
      padding: 12px;
      border: 2px solid #ddd;
      background: white;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-weight: 600;
    }

    .type-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    .type-btn.expense.active {
      background: #e74c3c;
      border-color: #e74c3c;
    }

    .type-btn.income.active {
      background: #2ecc71;
      border-color: #2ecc71;
    }

    .btn {
      background: #667eea;
      color: white;
      border: none;
      padding: 15px 30px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
    }

    .btn:hover {
      background: #5a67d8;
      transform: translateY(-2px);
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 12px;
      border-radius: 5px;
    }

    .btn-danger {
      background: #e74c3c;
    }

    .btn-danger:hover {
      background: #c0392b;
    }

    .btn-edit {
      background: #f39c12;
    }

    .btn-edit:hover {
      background: #e67e22;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .categories-section {
      background: white;
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #e9ecef;
    }

    .section-title {
      font-size: 1.3em;
      font-weight: bold;
      margin-bottom: 20px;
      color: #2c3e50;
      text-align: center;
    }

    .category-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 15px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #667eea;
    }

    .category-item.expense {
      border-left-color: #e74c3c;
    }

    .category-item.income {
      border-left-color: #2ecc71;
    }

    .category-info {
      flex: 1;
    }

    .category-name {
      font-weight: 600;
      color: #2c3e50;
      display: block;
    }

    .category-total {
      font-weight: bold;
      font-size: 1.1em;
      margin-left: 10px;
    }

    .category-total.expense {
      color: #e74c3c;
    }

    .category-total.income {
      color: #2ecc71;
    }

    .category-actions {
      display: flex;
      gap: 5px;
    }

    .transactions-section {
      grid-column: 1 / -1;
      background: white;
      border-radius: 15px;
      padding: 25px;
      border: 2px solid #e9ecef;
      margin-top: 20px;
    }

    .transaction-item {
      display: grid;
      grid-template-columns: auto 1fr auto auto auto;
      gap: 15px;
      padding: 15px;
      margin-bottom: 10px;
      background: #f8f9fa;
      border-radius: 8px;
      align-items: center;
    }

    .transaction-type {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      text-transform: uppercase;
    }

    .transaction-type.expense {
      background: #ffe5e5;
      color: #e74c3c;
    }

    .transaction-type.income {
      background: #e5f5e5;
      color: #2ecc71;
    }

    .transaction-category {
      font-weight: 600;
      color: #2c3e50;
    }

    .transaction-amount {
      font-weight: bold;
      font-size: 1.1em;
    }

    .transaction-amount.expense {
      color: #e74c3c;
    }

    .transaction-amount.income {
      color: #2ecc71;
    }

    .transaction-date {
      color: #7f8c8d;
      font-size: 0.9em;
    }

    .delete-btn {
      background: #e74c3c;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
    }

    .delete-btn:hover {
      background: #c0392b;
    }

    .add-category-section {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 2px solid #e9ecef;
    }

    .add-category-form {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .add-category-form input {
      flex: 1;
    }

    .add-category-form button {
      padding: 10px 15px;
      background: #2ecc71;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }

    .empty-state {
      text-align: center;
      color: #7f8c8d;
      padding: 40px;
      font-style: italic;
    }

    .period-form {
      background: rgba(255, 255, 255, 0.1);
      padding: 20px;
      border-radius: 15px;
      margin: 20px 0;
      backdrop-filter: blur(10px);
    }

    .period-form h3 {
      margin-bottom: 15px;
      color: white;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 15px;
      margin-bottom: 15px;
    }

    .period-list {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
    }

    .period-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      margin-bottom: 8px;
      background: #f8f9fa;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .period-item:hover {
      background: #e9ecef;
    }

    .period-item.active {
      background: #667eea;
      color: white;
    }

    .edit-category-form {
      display: none;
      margin-top: 10px;
      padding: 10px;
      background: #e9ecef;
      border-radius: 5px;
    }

    .edit-category-form input {
      margin-bottom: 10px;
    }

    .edit-category-form button {
      margin-right: 5px;
    }

    .user-id-display {
      position: absolute;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.2);
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      backdrop-filter: blur(10px);
      color: white;
    }

    .offline-indicator {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: #e74c3c;
      color: white;
      padding: 10px 15px;
      border-radius: 25px;
      font-size: 0.9em;
      display: none;
      z-index: 1000;
    }

    .sync-pending {
      position: fixed;
      bottom: 70px;
      right: 20px;
      background: #f39c12;
      color: white;
      padding: 8px 12px;
      border-radius: 20px;
      font-size: 0.8em;
      display: none;
      z-index: 1000;
    }

    @media (max-width: 768px) {
      .main-content {
        grid-template-columns: 1fr;
      }

      .transaction-item {
        grid-template-columns: 1fr auto;
        gap: 10px;
      }

      .transaction-item>*:not(.transaction-category):not(.transaction-amount) {
        display: none;
      }

      .period-selector {
        flex-direction: column;
      }

      .form-row {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <div class="offline-indicator" id="offlineIndicator">
    üì∂ Offline - Changes saved locally
  </div>

  <div class="sync-pending" id="syncPending">
    ‚è≥ Changes pending sync...
  </div>

  <div class="container">
    <div class="header">
      <div class="user-id-display" id="userIdDisplay">Loading...</div>
      <div class="sync-status" id="syncStatus">Local First</div>
      <h1>üí∞ Money Tracker Pro</h1>

      <div class="period-selector">
        <button class="period-btn" onclick="showPeriodManager()">üìÖ Manage Periods</button>
        <span id="currentPeriodName" style="color: white; font-weight: bold;">All Time</span>
      </div>

      <div class="grand-total" id="grandTotal">$0.00</div>
      <div>Total Revenue</div>
    </div>

    <div class="period-form" id="periodForm" style="display: none;">
      <h3>Create/Select Time Period</h3>
      <div class="form-row">
        <input type="text" id="periodName" placeholder="Period name (e.g., Summer 2026)">
        <input type="text" id="periodDescription" placeholder="Description (optional)">
      </div>
      <div class="form-row">
        <input type="date" id="periodStartDate">
        <input type="date" id="periodEndDate">
      </div>
      <button class="btn btn-small" onclick="createPeriod()">Create Period</button>
      <button class="btn btn-small btn-danger" onclick="hidePeriodManager()">Close</button>

      <div class="period-list" id="periodList">
        <div class="period-item active" onclick="selectPeriod(null)">
          <span>All Time</span>
          <span>‚àû</span>
        </div>
      </div>
    </div>

    <div class="main-content">
      <div class="input-section">
        <h2 class="section-title">Add Transaction</h2>

        <div class="type-selector">
          <button class="type-btn expense active" onclick="setType('expense')">Expense</button>
          <button class="type-btn income" onclick="setType('income')">Income</button>
        </div>

        <form id="transactionForm">
          <div class="form-group">
            <label for="category">Category:</label>
            <select id="category" required>
              <option value="">Select a category</option>
            </select>
          </div>

          <div class="form-group">
            <label for="amount">Amount:</label>
            <input type="number" id="amount" step="0.01" min="0.01" placeholder="0.00" required>
          </div>

          <div class="form-group">
            <label for="description">Description (optional):</label>
            <input type="text" id="description" placeholder="What was this for?">
          </div>

          <div class="form-group">
            <label for="date">Date:</label>
            <input type="date" id="date" required>
          </div>

          <button type="submit" class="btn">Add Transaction</button>
        </form>

        <div class="add-category-section">
          <h3>Manage Categories</h3>
          <div class="add-category-form">
            <input type="text" id="newCategoryName" placeholder="New category name">
            <button onclick="addCategory()">Add Category</button>
          </div>
          <div id="existingCategories" style="margin-top: 15px;"></div>
        </div>
      </div>

      <div class="sidebar">
        <div class="categories-section">
          <h2 class="section-title">Category Totals</h2>
          <div id="categoryTotals">
            <div class="empty-state">No transactions yet</div>
          </div>
        </div>
      </div>

      <div class="transactions-section">
        <h2 class="section-title">Recent Transactions</h2>
        <div id="transactionsList">
          <div class="empty-state">No transactions recorded yet. Add your first transaction above!</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyC5CeuH_W_h2tv4gWzIq6BM3iGPM3dZcG8",
      authDomain: "money-tracker-sync-4f7e5.firebaseapp.com",
      databaseURL: "https://money-tracker-sync-4f7e5-default-rtdb.firebaseio.com",
      projectId: "money-tracker-sync-4f7e5",
      storageBucket: "money-tracker-sync-4f7e5.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Get user ID from URL hash or generate new one
    function getUserId() {
      let userId = window.location.hash.substring(1);
      if (!userId) {
        userId = 'user_' + Math.random().toString(36).substr(2, 9);
        window.location.hash = userId;
      }
      return userId;
    }

    const userId = getUserId();
    document.getElementById('userIdDisplay').textContent = `User: ${userId}`;

    // LOCAL-FIRST ARCHITECTURE
    let transactions = [];
    let categories = {
      expense: ['Food', 'Transportation', 'Entertainment', 'Shopping', 'Bills'],
      income: ['Salary', 'Freelance', 'Investment', 'Other']
    };
    let periods = [];
    let currentPeriod = null;
    let currentType = 'expense';
    let editingCategory = null;

    // Sync state
    let isOnline = true;
    let syncQueue = [];
    let isSyncing = false;

    // LOCAL STORAGE KEYS
    const LOCAL_KEYS = {
      transactions: `money_tracker_${userId}_transactions`,
      categories: `money_tracker_${userId}_categories`,
      periods: `money_tracker_${userId}_periods`,
      syncQueue: `money_tracker_${userId}_sync_queue`
    };

    // LOCAL STORAGE FUNCTIONS
    function saveLocal(key, data) {
      try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
      } catch (e) {
        console.warn('Local storage failed:', e);
        return false;
      }
    }

    function loadLocal(key, defaultValue = null) {
      try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
      } catch (e) {
        console.warn('Local storage load failed:', e);
        return defaultValue;
      }
    }

    // INSTANT LOCAL SAVE - Always works immediately
    function saveInstantly(type, data) {
      // Save to local storage first (instant)
      let saved = false;
      switch (type) {
        case 'transactions':
          transactions = data;
          saved = saveLocal(LOCAL_KEYS.transactions, data);
          break;
        case 'categories':
          categories = data;
          saved = saveLocal(LOCAL_KEYS.categories, data);
          break;
        case 'periods':
          periods = data;
          saved = saveLocal(LOCAL_KEYS.periods, data);
          break;
      }

      // Queue for cloud sync (background)
      if (saved) {
        queueForSync(type, data);
        updateSyncStatus('local-first');
        setTimeout(() => updateSyncStatus(isOnline ? 'connected' : 'offline'), 1000);
      }

      return saved;
    }

    // CLOUD SYNC QUEUE
    function queueForSync(type, data) {
      const syncItem = {
        type: type,
        data: data,
        timestamp: Date.now(),
        userId: userId
      };

      syncQueue.push(syncItem);
      saveLocal(LOCAL_KEYS.syncQueue, syncQueue);

      // Try to sync immediately if online
      if (isOnline && !isSyncing) {
        processSyncQueue();
      } else {
        showSyncPending();
      }
    }

    // PROCESS SYNC QUEUE
    async function processSyncQueue() {
      if (isSyncing || syncQueue.length === 0) return;

      isSyncing = true;
      updateSyncStatus('syncing');

      const item = syncQueue[0];

      try {
        await database.ref(`${userId}/${item.type}`).set(item.data);

        // Success - remove from queue
        syncQueue.shift();
        saveLocal(LOCAL_KEYS.syncQueue, syncQueue);

        if (syncQueue.length === 0) {
          hideSyncPending();
          updateSyncStatus('connected');
        } else {
          // Process next item
          setTimeout(() => processSyncQueue(), 100);
        }
      } catch (error) {
        console.error('Sync failed:', error);
        updateSyncStatus('offline');
        // Keep item in queue for retry
      } finally {
        isSyncing = false;
      }
    }

    // FIREBASE LISTENERS (for multi-device sync)
    function setupFirebaseListeners() {
      // Listen for changes from other devices
      database.ref(`${userId}/transactions`).on('value', snapshot => {
        const cloudData = snapshot.val();
        if (cloudData && JSON.stringify(cloudData) !== JSON.stringify(transactions)) {
          transactions = cloudData;
          saveLocal(LOCAL_KEYS.transactions, cloudData);
          updateCategoryTotals();
          updateTransactionsList();
          updateGrandTotal();
          updateSyncStatus('connected');
        }
      });

      database.ref(`${userId}/categories`).on('value', snapshot => {
        const cloudData = snapshot.val();
        if (cloudData && JSON.stringify(cloudData) !== JSON.stringify(categories)) {
          categories = cloudData;
          saveLocal(LOCAL_KEYS.categories, cloudData);
          updateCategorySelect();
          displayExistingCategories();
          updateCategoryTotals();
        }
      });

      database.ref(`${userId}/periods`).on('value', snapshot => {
        const cloudData = snapshot.val();
        if (cloudData && JSON.stringify(cloudData) !== JSON.stringify(periods)) {
          periods = cloudData;
          saveLocal(LOCAL_KEYS.periods, cloudData);
          updatePeriodsList();
        }
      });
    }

    // UPDATE SYNC STATUS
    function updateSyncStatus(status) {
      const syncElement = document.getElementById('syncStatus');
      switch (status) {
        case 'connected':
          syncElement.textContent = '‚óè Cloud Synced';
          syncElement.className = 'sync-status connected';
          break;
        case 'syncing':
          syncElement.textContent = '‚óè Syncing...';
          syncElement.className = 'sync-status syncing';
          break;
        case 'offline':
          syncElement.textContent = '‚óè Local Only';
          syncElement.className = 'sync-status offline';
          break;
        case 'local-first':
          syncElement.textContent = '‚óè Saved Locally';
          syncElement.className = 'sync-status local-first';
          break;
      }
    }

    function showSyncPending() {
      document.getElementById('syncPending').style.display = 'block';
    }

    function hideSyncPending() {
      document.getElementById('syncPending').style.display = 'none';
    }

    // PERIOD MANAGEMENT
    function showPeriodManager() {
      document.getElementById('periodForm').style.display = 'block';
    }

    function hidePeriodManager() {
      document.getElementById('periodForm').style.display = 'none';
    }

    function createPeriod() {
      const name = document.getElementById('periodName').value.trim();
      const description = document.getElementById('periodDescription').value.trim();
      const startDate = document.getElementById('periodStartDate').value;
      const endDate = document.getElementById('periodEndDate').value;

      if (!name || !startDate || !endDate) {
        alert('Please fill in all required fields');
        return;
      }

      if (new Date(startDate) > new Date(endDate)) {
        alert('Start date must be before end date');
        return;
      }

      const period = {
        id: Date.now(),
        name: name,
        description: description,
        startDate: startDate,
        endDate: endDate
      };

      periods.push(period);
      saveInstantly('periods', periods);

      // Clear form
      document.getElementById('periodName').value = '';
      document.getElementById('periodDescription').value = '';
      document.getElementById('periodStartDate').value = '';
      document.getElementById('periodEndDate').value = '';
    }

    function updatePeriodsList() {
      const periodList = document.getElementById('periodList');
      let html = `
                <div class="period-item active" onclick="selectPeriod(null)">
                    <span>All Time</span>
                    <span>‚àû</span>
                </div>
            `;

      periods.forEach(period => {
        const startDate = new Date(period.startDate).toLocaleDateString();
        const endDate = new Date(period.endDate).toLocaleDateString();
        html += `
                    <div class="period-item ${currentPeriod && currentPeriod.id === period.id ? 'active' : ''}" 
                         onclick="selectPeriod(${period.id})">
                        <span>${period.name}</span>
                        <span>${startDate} - ${endDate}</span>
                    </div>
                `;
      });

      periodList.innerHTML = html;
    }

    function selectPeriod(periodId) {
      if (periodId === null) {
        currentPeriod = null;
        document.getElementById('currentPeriodName').textContent = 'All Time';
      } else {
        currentPeriod = periods.find(p => p.id === periodId);
        document.getElementById('currentPeriodName').textContent = currentPeriod.name;
      }

      updateCategoryTotals();
      updateTransactionsList();
      updateGrandTotal();
      updatePeriodsList();
      hidePeriodManager();
    }

    function getFilteredTransactions() {
      if (!currentPeriod) {
        return transactions;
      }

      const startDate = new Date(currentPeriod.startDate);
      const endDate = new Date(currentPeriod.endDate);

      return transactions.filter(transaction => {
        const transactionDate = new Date(transaction.date);
        return transactionDate >= startDate && transactionDate <= endDate;
      });
    }

    // SET TRANSACTION TYPE
    function setType(type) {
      currentType = type;
      document.querySelectorAll('.type-btn').forEach(btn => btn.classList.remove('active'));
      document.querySelector(`.type-btn.${type}`).classList.add('active');
      updateCategorySelect();
      displayExistingCategories();
    }

    // UPDATE CATEGORY DROPDOWN
    function updateCategorySelect() {
      const categorySelect = document.getElementById('category');
      categorySelect.innerHTML = '<option value="">Select a category</option>';

      categories[currentType].forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        categorySelect.appendChild(option);
      });
    }

    // DISPLAY EXISTING CATEGORIES
    function displayExistingCategories() {
      const container = document.getElementById('existingCategories');
      let html = `<h4>Existing ${currentType} categories:</h4>`;

      categories[currentType].forEach((category, index) => {
        html += `
                    <div class="category-item ${currentType}" style="margin-bottom: 5px;">
                        <span class="category-name">${category}</span>
                        <div class="category-actions">
                            <button class="btn btn-small btn-edit" onclick="editCategory('${category}')">Edit</button>
                            <button class="btn btn-small btn-danger" onclick="deleteCategory('${category}')">Delete</button>
                        </div>
                    </div>
                    <div id="editForm-${category.replace(/\s+/g, '-')}" class="edit-category-form">
                        <input type="text" id="editInput-${category.replace(/\s+/g, '-')}" value="${category}" placeholder="Category name">
                        <button class="btn btn-small" onclick="saveCategoryEdit('${category}')">Save</button>
                        <button class="btn btn-small btn-danger" onclick="cancelCategoryEdit('${category}')">Cancel</button>
                    </div>
                `;
      });

      container.innerHTML = html;
    }

    // ADD NEW CATEGORY
    function addCategory() {
      const input = document.getElementById('newCategoryName');
      const categoryName = input.value.trim();

      if (categoryName && !categories[currentType].includes(categoryName)) {
        categories[currentType].push(categoryName);
        saveInstantly('categories', categories);
        input.value = '';

        // Show confirmation
        const originalBtn = event.target;
        originalBtn.textContent = 'Added!';
        originalBtn.style.background = '#2ecc71';
        setTimeout(() => {
          originalBtn.textContent = 'Add Category';
          originalBtn.style.background = '#2ecc71';
        }, 1000);
      }
    }

    // EDIT CATEGORY
    function editCategory(categoryName) {
      // Hide all other edit forms
      document.querySelectorAll('.edit-category-form').forEach(form => {
        form.style.display = 'none';
      });

      // Show the edit form for this category
      const formId = `editForm-${categoryName.replace(/\s+/g, '-')}`;
      document.getElementById(formId).style.display = 'block';
      editingCategory = categoryName;
    }

    // SAVE CATEGORY EDIT
    function saveCategoryEdit(oldCategoryName) {
      const inputId = `editInput-${oldCategoryName.replace(/\s+/g, '-')}`;
      const newCategoryName = document.getElementById(inputId).value.trim();

      if (newCategoryName && !categories[currentType].includes(newCategoryName)) {
        // Update category in categories array
        const index = categories[currentType].indexOf(oldCategoryName);
        if (index > -1) {
          categories[currentType][index] = newCategoryName;
          saveInstantly('categories', categories);
        }

        // Update transactions that use this category
        transactions.forEach(transaction => {
          if (transaction.type === currentType && transaction.category === oldCategoryName) {
            transaction.category = newCategoryName;
          }
        });
        saveInstantly('transactions', transactions);
      }

      cancelCategoryEdit(oldCategoryName);
    }

    // CANCEL CATEGORY EDIT
    function cancelCategoryEdit(categoryName) {
      const formId = `editForm-${categoryName.replace(/\s+/g, '-')}`;
      document.getElementById(formId).style.display = 'none';
      editingCategory = null;
    }

    // DELETE CATEGORY
    function deleteCategory(categoryName) {
      if (confirm(`Are you sure you want to delete the category "${categoryName}"? All transactions in this category will be preserved but will show "Unknown" as the category.`)) {
        // Remove from categories array
        const index = categories[currentType].indexOf(categoryName);
        if (index > -1) {
          categories[currentType].splice(index, 1);
          saveInstantly('categories', categories);
        }

        // Update transactions that use this category to "Unknown"
        transactions.forEach(transaction => {
          if (transaction.type === currentType && transaction.category === categoryName) {
            transaction.category = 'Unknown';
          }
        });
        saveInstantly('transactions', transactions);

        // Add "Unknown" category if it doesn't exist
        if (!categories[currentType].includes('Unknown')) {
          categories[currentType].push('Unknown');
          saveInstantly('categories', categories);
        }
      }
    }

    // ADD TRANSACTION - LOCAL FIRST!
    document.getElementById('transactionForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const transaction = {
        id: Date.now(),
        type: currentType,
        category: document.getElementById('category').value,
        amount: parseFloat(document.getElementById('amount').value),
        description: document.getElementById('description').value,
        date: document.getElementById('date').value
      };

      // INSTANT LOCAL SAVE
      transactions.unshift(transaction);
      saveInstantly('transactions', transactions);

      // Reset form immediately
      this.reset();
      document.getElementById('date').valueAsDate = new Date();
    });

    // UPDATE DISPLAYS
    function updateCategoryTotals() {
      const totalsContainer = document.getElementById('categoryTotals');
      const filteredTransactions = getFilteredTransactions();
      const totals = {};

      // Calculate totals
      filteredTransactions.forEach(transaction => {
        const key = `${transaction.type}-${transaction.category}`;
        if (!totals[key]) {
          totals[key] = {
            type: transaction.type,
            category: transaction.category,
            total: 0
          };
        }
        totals[key].total += transaction.amount;
      });

      // Display totals
      if (Object.keys(totals).length === 0) {
        totalsContainer.innerHTML = '<div class="empty-state">No transactions in this period</div>';
        return;
      }

      let html = '';
      Object.values(totals).forEach(total => {
        html += `
                    <div class="category-item ${total.type}">
                        <span class="category-name">${total.category}</span>
                        <span class="category-total ${total.type}">
                            ${total.type === 'expense' ? '-' : '+'}$${total.total.toFixed(2)}
                        </span>
                    </div>
                `;
      });

      totalsContainer.innerHTML = html;
    }

    function updateTransactionsList() {
      const listContainer = document.getElementById('transactionsList');
      const filteredTransactions = getFilteredTransactions();

      if (filteredTransactions.length === 0) {
        listContainer.innerHTML = '<div class="empty-state">No transactions in this period. Add your first transaction above!</div>';
        return;
      }

      let html = '';
      filteredTransactions.slice(0, 20).forEach(transaction => {
        const date = new Date(transaction.date);
        const formattedDate = date.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });

        html += `
                    <div class="transaction-item">
                        <span class="transaction-type ${transaction.type}">${transaction.type}</span>
                        <span class="transaction-category">${transaction.category}</span>
                        <span class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'expense' ? '-' : '+'}$${transaction.amount.toFixed(2)}
                        </span>
                        <span class="transaction-date">${formattedDate}</span>
                        <button class="delete-btn" onclick="deleteTransaction(${transaction.id})">Delete</button>
                    </div>
                `;
      });

      listContainer.innerHTML = html;
    }

    function updateGrandTotal() {
      const filteredTransactions = getFilteredTransactions();
      const grandTotal = filteredTransactions.reduce((total, transaction) => {
        return transaction.type === 'income'
          ? total + transaction.amount
          : total - transaction.amount;
      }, 0);

      const grandTotalElement = document.getElementById('grandTotal');
      grandTotalElement.textContent = `$${Math.abs(grandTotal).toFixed(2)}`;
      grandTotalElement.className = `grand-total ${grandTotal >= 0 ? 'positive' : 'negative'}`;
    }

    // DELETE TRANSACTION
    function deleteTransaction(id) {
      transactions = transactions.filter(t => t.id !== id);
      saveInstantly('transactions', transactions);
    }

    // MONITOR CONNECTION STATUS
    window.addEventListener('online', () => {
      isOnline = true;
      document.getElementById('offlineIndicator').style.display = 'none';
      processSyncQueue(); // Process any pending syncs
    });

    window.addEventListener('offline', () => {
      isOnline = false;
      document.getElementById('offlineIndicator').style.display = 'block';
      updateSyncStatus('offline');
    });

    // INITIALIZATION
    function initializeApp() {
      // Load from local storage first (instant)
      transactions = loadLocal(LOCAL_KEYS.transactions, []);
      categories = loadLocal(LOCAL_KEYS.categories, categories);
      periods = loadLocal(LOCAL_KEYS.periods, periods);
      syncQueue = loadLocal(LOCAL_KEYS.syncQueue, []);

      // Update UI immediately
      updateCategorySelect();
      displayExistingCategories();
      updateCategoryTotals();
      updateTransactionsList();
      updateGrandTotal();
      updatePeriodsList();

      // Set up Firebase listeners for multi-device sync
      setupFirebaseListeners();

      // Process any pending syncs
      if (isOnline && syncQueue.length > 0) {
        processSyncQueue();
      }

      // Set today's date
      document.getElementById('date').valueAsDate = new Date();
    }

    // START THE APP
    initializeApp();

    // Add enter key support for category addition
    document.getElementById('newCategoryName').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        addCategory();
      }
    });
  </script>
</body>

</html>